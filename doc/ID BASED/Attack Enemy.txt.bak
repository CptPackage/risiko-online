CREATE PROCEDURE `Attack` 
(
	IN srcMatchNumber INT UNSIGNED, IN turnNumber INT(3) UNSIGNED,
	IN attackerNation VARCHAR(32), IN defenderNation VARCHAR(32)
)
BEGIN
DECLARE EXIT HANDLER FOR SQLEXCEPTION ROLLBACK;
	START TRANSACTION;

		## Check if Nations are neighbours
		CALL IsNeighbourNation(attackerNation,defenderNation,@AreNeighbours);
        
		IF @AreNeighbours IS NULL OR @AreNeighbours = 0 THEN 
			SIGNAL SQLSTATE '45000' SET message_text = `Attacker and Defender nations have to be neighbours!`;
            ROLLBACK;
        END IF;
		
		
		## Get Attacker Tanks
		SELECT occupier, occupyingTanksNumber into @Attacker, @AttackerTanks
		FROM Territory AS T
		WHERE T.matchNumber = srcMatchNumber
		AND T.nation = sourceNation;
        
		
		## Cancel Attack if Source Nation has 1 or less tanks
        IF @AttackerTanks IS NULL THEN 
			SIGNAL SQLSTATE '45000' SET message_text = `Can't attack from a foreign territory!`;
            ROLLBACK;
        ELSEIF @AttackerTanks = 1 THEN
        	SIGNAL SQLSTATE '45000' SET message_text = `Not enough tanks! (At least 1 tank has to defend the territory)`;
			ROLLBACK;
		END IF;

		## Calculate Attacker's Dice Count
		CALL GetThrowableDiceCount(@AttackerTanks,@AttackerDiceCount);

 
		## Get Defender Tanks
		SELECT occupier, occupyingTanksNumber into @Defender, @DefenderTanks
		FROM Territory AS T
		WHERE T.matchNumber = srcMatchNumber
		AND T.nation = defenderNation;

		## Calculate Defender's Dice Count
		CALL GetThrowableDiceCount(@DefenderTanks,@DefenderDiceCount);
        
 
		SET @ActionNumber = 1;
		
		INSERT INTO `Action`(matchNumber,turnNumber,actionNumber,player,targetNation,tanksNumber)
		VALUES (srcMatchNumber,turnNumber,@ActionNumber,@Attacker,defenderNation,@AttackerTanks);
			
        INSERT INTO `Combat`(
			matchNumber,turnNumber,actionNumber, attackerNation,
			defenderPlayer,defenderTanksNumber, succeded
        )
		VALUES (
			srcMatchNumber,turnNumber,@ActionNumber,attackerNation,
			@Defender,@DefenderTanks,@AttackSuccess
        );
		
		CALL GetCombatResults(
			srcMatchNumber, turnNumber, 
			@Attacker, @AttackerDiceCount,
			@Defender, @DefenderDiceCount,
			@AttackerLostTanks, @DefenderLostTanks
		);	

		IF @AttackerLostTanks > 0 THEN 
			UPDATE Territory AS T
            SET T.occupier = @Attacker, T.tanksNumber = (@AttackerTanks - @AttackerLostTanks)
            WHERE T.matchNumber = srcMatchNumber
            AND T.nation = attackerNation;
		END IF;
		

		## AttackSuccess defines if the player occupied that nation
		SET @AttackSuccess := CASE WHEN (@DefenderTanks - @DefenderLostTanks) <= 0 THEN 1 ELSE 0 END;
        
        IF @AttackSuccess = 1 THEN
			UPDATE Territory AS T
            SET T.occupier = @Attacker AND T.tanksNumber = 1
            WHERE T.matchNumber = srcMatchNumber
            AND T.nation = defenderNation;
		ELSEIF @DefenderLostTanks > 0 THEN 
			UPDATE Territory AS T
            SET T.occupier = @Defender, T.tanksNumber = (@DefenderTanks - @DefenderLostTanks)
            WHERE T.matchNumber = srcMatchNumber
            AND T.nation = defenderNation;
        END IF;
        
    COMMIT;
END